@page "/game2d"
@inject IJSRuntime JS
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Smart Girl Algebra - 2D Game</PageTitle>

<!-- Navigation Bar -->
<div class="nav-bar">
    <button class="nav-btn" @onclick="GoHome" title="Home">🏠 Home</button>
    <div class="nav-user">
        <span>🎮 2D Platformer Game</span>
    </div>
</div>

<div class="game-container">
    @if (!gameStarted)
    {
        <div class="game-intro">
            <h1 class="game-title">🎮 Smart Girl Algebra Adventure! 🎮</h1>
            <div class="intro-card">
                <h2>Welcome to the Algebra World!</h2>
                <p style="font-size: 1.2em; margin: 20px 0;">
                    Jump, run, and collect algebra problems in this exciting 2D platformer!
                </p>
                
                <div class="game-features">
                    <div class="feature">
                        <div class="feature-icon">🏃‍♀️</div>
                        <div class="feature-text">Run and jump through levels</div>
                    </div>
                    <div class="feature">
                        <div class="feature-icon">💰</div>
                        <div class="feature-text">Collect coins for points</div>
                    </div>
                    <div class="feature">
                        <div class="feature-icon">❓</div>
                        <div class="feature-text">Solve algebra problems</div>
                    </div>
                    <div class="feature">
                        <div class="feature-icon">🏆</div>
                        <div class="feature-text">Level up and unlock achievements</div>
                    </div>
                </div>
                
                <div class="controls-info">
                    <h3>Controls:</h3>
                    <p>⬅️ ➡️ Arrow Keys or A/D - Move left/right</p>
                    <p>SPACE - Jump</p>
                </div>
                
                <button class="btn btn-large" @onclick="StartGame">🚀 Start Adventure!</button>
            </div>
        </div>
    }
    else
    {
        <div class="game-wrapper">
            <!-- Game Instructions HUD -->
            <div class="game-hud">
                <div class="hud-instructions">
                    <h3 style="margin: 0 0 10px 0; color: var(--primary-pink);">🎮 How to Play:</h3>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div><strong>⬅️ ➡️</strong> or <strong>A/D</strong> - Move</div>
                        <div><strong>SPACE</strong> - Jump</div>
                        <div><strong>💰</strong> Collect coins</div>
                        <div><strong>❓</strong> Answer questions</div>
                    </div>
                </div>
            </div>

            <canvas id="gameCanvas" width="800" height="600"></canvas>

            @if (showProblemModal)
            {
                <div class="problem-modal">
                    <div class="problem-card">
                        <h2>🎯 Algebra Challenge!</h2>
                        <p class="problem-question">@currentProblem</p>

                        @if (problemType == "slider")
                        {
                            <div class="slider-activity">
                                <h3>How many pompoms? @sliderValue</h3>
                                <input type="range" min="@minValue" max="@maxValue" @bind="sliderValue" @bind:event="oninput" class="game-slider" />
                                <div class="slider-labels">
                                    <span>@minValue</span>
                                    <span style="font-size: 2em; color: var(--primary-pink);">@sliderValue pompoms</span>
                                    <span>@maxValue</span>
                                </div>
                            </div>
                        }
                        else if (problemType == "target")
                        {
                            <div class="target-activity">
                                <h3>Click the correct answer!</h3>
                                <div class="moving-targets">
                                    @foreach (var option in targetOptions)
                                    {
                                        <button class="target-btn @GetTargetClass(option)"
                                                @onclick="() => SelectTarget(option)"
                                                style="animation-delay: @(option * 0.1)s;">
                                            @option
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                        else if (problemType == "balance")
                        {
                            <div class="balance-activity">
                                <h3>How many candy bars?</h3>
                                <div class="balance-controls">
                                    <button class="balance-btn" @onclick="() => AdjustBalance(-1)">➖</button>
                                    <div class="balance-display">@balanceValue candy bars</div>
                                    <button class="balance-btn" @onclick="() => AdjustBalance(1)">➕</button>
                                </div>
                            </div>
                        }
                        else if (problemType == "drag")
                        {
                            <div class="drag-activity">
                                <h3>Drag the answer to the box!</h3>
                                <div class="drag-target" @ondrop="HandleDrop" @ondragover="HandleDragOver">
                                    @if (draggedValue.HasValue)
                                    {
                                        <span class="dropped-value">@draggedValue</span>
                                    }
                                    else
                                    {
                                        <span class="drop-hint">Drop here</span>
                                    }
                                </div>
                                <div class="drag-options">
                                    @foreach (var option in dragOptions)
                                    {
                                        <div class="drag-item" draggable="true"
                                             @ondragstart="() => StartDrag(option)">
                                            @option
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        <br/>
                        <button class="btn btn-large" @onclick="CheckAnswer">✓ Check Answer</button>
                        <button class="btn" style="background: #95a5a6;" @onclick="CloseProblem">Skip</button>

                        @if (!string.IsNullOrEmpty(feedbackMessage))
                        {
                            <div class="feedback @feedbackClass">@feedbackMessage</div>
                        }
                    </div>
                </div>
            }
            
            <div class="game-controls">
                <button class="btn" @onclick="BackToMenu">🏠 Back to Menu</button>
                <button class="btn" @onclick="RestartLevel">🔄 Restart Level</button>
            </div>
        </div>
    }
</div>

@code {
    private bool gameStarted = false;
    private bool showProblemModal = false;
    private string currentProblem = "";
    private string problemType = "";
    private int correctAnswer = 0;
    private string feedbackMessage = "";
    private string feedbackClass = "";
    private DotNetObjectReference<Game2D>? dotNetRef;

    // Slider activity
    private int sliderValue = 0;
    private int minValue = 0;
    private int maxValue = 10;

    // Target activity
    private List<int> targetOptions = new();
    private int? selectedTarget = null;

    // Balance activity
    private int balanceValue = 0;

    // Drag activity
    private List<int> dragOptions = new();
    private int? draggedValue = null;
    private int currentDragItem = 0;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                Console.WriteLine("Setting up Blazor game reference...");
                dotNetRef = DotNetObjectReference.Create(this);

                // Create a helper function in JavaScript to set the reference
                await JS.InvokeVoidAsync("eval", @"
                    window.setBlazorGameReference = function(ref) {
                        window.blazorGame = ref;
                        console.log('Blazor game reference set!', window.blazorGame);
                    }
                ");

                await JS.InvokeVoidAsync("setBlazorGameReference", dotNetRef);
                Console.WriteLine("Blazor game reference set successfully!");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing game: {ex.Message}");
                Console.WriteLine($"Stack trace: {ex.StackTrace}");
            }
        }
    }

    private async Task StartGame()
    {
        try
        {
            gameStarted = true;
            StateHasChanged();
            await Task.Delay(100); // Wait for canvas to render
            await JS.InvokeVoidAsync("initGame", "gameCanvas");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error starting game: {ex.Message}");
            feedbackMessage = $"Error starting game: {ex.Message}";
            feedbackClass = "incorrect";
        }
    }

    [JSInvokable]
    public void ShowProblem(string type, string question, int answer, int min, int max, string optionsJson)
    {
        Console.WriteLine($"ShowProblem called! Type: {type}, Question: {question}");

        problemType = type;
        currentProblem = question;
        correctAnswer = answer;
        feedbackMessage = "";

        // Reset all activity states
        sliderValue = min;
        minValue = min;
        maxValue = max;
        selectedTarget = null;
        balanceValue = 0;
        draggedValue = null;

        // Parse options for target and drag activities
        if (!string.IsNullOrEmpty(optionsJson) && optionsJson != "[]")
        {
            try
            {
                targetOptions = System.Text.Json.JsonSerializer.Deserialize<List<int>>(optionsJson) ?? new();
                dragOptions = new List<int>(targetOptions);
            }
            catch
            {
                targetOptions = new List<int> { answer - 2, answer, answer + 2, answer + 4 };
                dragOptions = new List<int>(targetOptions);
            }
        }
        else
        {
            targetOptions = new List<int> { answer - 2, answer, answer + 2, answer + 4 };
            dragOptions = new List<int>(targetOptions);
        }

        showProblemModal = true;
        Console.WriteLine($"showProblemModal set to: {showProblemModal}");
        StateHasChanged();
        Console.WriteLine("StateHasChanged called!");
    }

    private async Task CheckAnswer()
    {
        int userAnswer = 0;

        switch (problemType)
        {
            case "slider":
                userAnswer = sliderValue;
                break;
            case "target":
                if (!selectedTarget.HasValue) return;
                userAnswer = selectedTarget.Value;
                break;
            case "balance":
                userAnswer = balanceValue;
                break;
            case "drag":
                if (!draggedValue.HasValue) return;
                userAnswer = draggedValue.Value;
                break;
        }

        if (userAnswer == correctAnswer)
        {
            feedbackMessage = "🎉 YASSS! Perfect! +50 points!";
            feedbackClass = "success";
            await JS.InvokeVoidAsync("addScore", 50);
            await Task.Delay(1500);
            CloseProblem();
        }
        else
        {
            feedbackMessage = $"❌ Not quite! Try again!";
            feedbackClass = "error";
        }
        StateHasChanged();
    }

    private void SelectTarget(int value)
    {
        selectedTarget = value;
        StateHasChanged();
    }

    private string GetTargetClass(int value)
    {
        return selectedTarget == value ? "selected" : "";
    }

    private void AdjustBalance(int delta)
    {
        balanceValue += delta;
        if (balanceValue < 0) balanceValue = 0;
        if (balanceValue > 10) balanceValue = 10;
        StateHasChanged();
    }

    private void StartDrag(int value)
    {
        currentDragItem = value;
    }

    private void HandleDragOver(DragEventArgs e)
    {
        // Allow drop
    }

    private void HandleDrop(DragEventArgs e)
    {
        draggedValue = currentDragItem;
        StateHasChanged();
    }

    private void CloseProblem()
    {
        showProblemModal = false;
        feedbackMessage = "";
        StateHasChanged();
    }

    private void BackToMenu()
    {
        Navigation.NavigateTo("/");
    }

    private void GoHome()
    {
        Navigation.NavigateTo("/");
    }

    private async Task RestartLevel()
    {
        await JS.InvokeVoidAsync("stopGame");
        await Task.Delay(100);
        await JS.InvokeVoidAsync("initGame", "gameCanvas");
    }

    public void Dispose()
    {
        dotNetRef?.Dispose();
    }
}

<style>
    .game-hud {
        position: absolute;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10;
        background: rgba(255, 255, 255, 0.95);
        padding: 15px 25px;
        border-radius: 15px;
        border: 3px solid var(--primary-pink);
        box-shadow: 0 4px 15px rgba(255, 20, 147, 0.3);
        max-width: 90%;
    }

    .hud-instructions {
        font-size: 0.9em;
        text-align: center;
    }

    .hud-instructions > div {
        justify-content: center;
    }

    .hud-instructions strong {
        color: var(--primary-pink);
    }

    .game-wrapper {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
    }

    #gameCanvas {
        border: 4px solid var(--primary-pink);
        border-radius: 10px;
        box-shadow: 0 8px 30px rgba(255, 20, 147, 0.4);
        background: linear-gradient(135deg, #e0f7ff 0%, #fff0f8 100%);
    }
</style>
